<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inicio</title>

<link rel="stylesheet"
href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

<style>
body {
    background: #f3f4f6;
    font-family: "Segoe UI", sans-serif;
}

/* ==================== TARJETA DE BIENVENIDA ==================== */

.card-welcome {
    background: white;
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.edificio {
    color: #0b8e2d;
    font-size: 20px;
    font-weight: 600;
}

/* ==================== SLIDE TO OPEN ==================== */

#slideContainer {
    position: relative;
    background: #e5e5e5;
    width: 100%;
    height: 60px;
    border-radius: 40px;
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.2);
    margin-bottom: 25px;
    user-select: none;
}

#slideTrack {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
    color: #6b6b6b;
    pointer-events: none;
}

#slideTrack::after {
    content: "DeslizÃ¡ para abrir ðŸ”“";
}

#slider {
    position: absolute;
    top: 5px;
    left: 5px;
    width: 50px;
    height: 50px;
    background: #0aa02c;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 26px;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
}

#slider.active {
    background: #088a25;
}

#slider.success {
    background: #0aa02c;
    box-shadow: 0 0 12px #0aa02c;
    transform: scale(1.1);
}

/* ==================== SLIDER DE NOVEDADES ==================== */

.slider {
    overflow-x: auto;
    white-space: nowrap;
    padding-bottom: 10px;
}

.slider-item {
    display: inline-block;
    width: calc(100vw - 60px);
    padding: 20px;
    margin-right: 15px;
    background: white;
    border-radius: 15px;
    vertical-align: top;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    white-space: normal;
}

.slider-item h5 {
    font-size: 18px;
    margin-bottom: 5px;
}

.slider-item small {
    font-size: 13px;
    color: #444;
}

.slider-item p {
    font-size: 15px;
    margin-top: 8px;
}

/* ==================== MENÃš PRINCIPAL ==================== */

.menu-grid .menu-box {
    background: white;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    cursor: pointer;
}
.menu-box img {
    width: 40px;
    margin-bottom: 10px;
}
</style>
</head>

<body>

<div class="container mt-4">

    <!-- ==================== BIENVENIDA ==================== -->
    <div class="card-welcome text-center">
        <h3 id="saludo">Cargando...</h3>
        <div class="edificio" id="nombreEdificio">Machain 3573</div>
    </div>

    <!-- ==================== SLIDE PARA ABRIR PUERTA ==================== -->
    <div id="slideContainer">
        <div id="slideTrack"></div>
        <div id="slider">
            ðŸ”“
        </div>
    </div>

    <p id="msgPuerta" class="text-center fw-bold"></p>

    <!-- ==================== SLIDER DE NOTICIAS ==================== -->
    <h4 class="mb-2">Novedades</h4>
    <div id="sliderNoticias" class="slider"></div>

    <!-- ==================== MENÃš PRINCIPAL ==================== -->
    <div class="menu-grid row row-cols-2 g-3 mt-4">

        <div class="col">
            <div class="menu-box" onclick="location.href='acceso.html'">
                <img src="https://cdn-icons-png.flaticon.com/512/1828/1828778.png">
                Control de acceso
            </div>
        </div>

        <div class="col">
            <div class="menu-box">
                <img src="https://cdn-icons-png.flaticon.com/512/1828/1828859.png">
                Novedades
            </div>
        </div>

        <div class="col">
            <div class="menu-box" onclick="location.href='reservas.html'">
                <img src="https://cdn-icons-png.flaticon.com/512/1828/1828843.png">
                Reservas
            </div>
        </div>

        <div class="col">
            <div class="menu-box">
                <img src="https://cdn-icons-png.flaticon.com/512/1828/1828919.png">
                Consultas
            </div>
        </div>

    </div>

    <hr>
    <button class="btn btn-danger w-100" onclick="logout()">Cerrar sesiÃ³n</button>

</div>

<script>
// ==================== OBTENER USUARIO LOGUEADO ====================
async function loadUser() {
    const resp = await fetch("http://localhost:3000/api/me", {
        credentials: "include"
    });

    if (resp.status === 401) {
        location.href = "login.html";
        return;
    }

    const data = await resp.json();
    document.getElementById("saludo").innerText = "Â¡Hola vecino " + data.uf + "!";
}
loadUser();

// ==================== CARGAR NOTICIAS ====================
async function loadNoticias() {
    const r = await fetch("http://localhost:3000/api/noticias");
    const data = await r.json();

    const slider = document.getElementById("sliderNoticias");
    slider.innerHTML = "";

    data.forEach(n => {
        slider.innerHTML += `
            <div class="slider-item">
                <h5>${n.titulo}</h5>
                <small>${n.fecha}</small>
                <p>${n.texto}</p>
            </div>
        `;
    });
}
loadNoticias();

// =====================================================
// ========== SLIDE TO OPEN PUERTA + VIBRACIÃ“N =========
// =====================================================

let sliding = false;
let startX = 0;

const sliderBtn = document.getElementById("slider");
const container = document.getElementById("slideContainer");
const msg = document.getElementById("msgPuerta");

sliderBtn.addEventListener("mousedown", startSlide);
sliderBtn.addEventListener("touchstart", startSlide);

function startSlide(e) {
    sliding = true;
    startX = e.touches ? e.touches[0].clientX : e.clientX;
    sliderBtn.classList.add("active");
}

document.addEventListener("mousemove", moveSlide);
document.addEventListener("touchmove", moveSlide);

document.addEventListener("mouseup", endSlide);
document.addEventListener("touchend", endSlide);

function moveSlide(e) {
    if (!sliding) return;

    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const diff = clientX - startX;

    const maxLeft = container.clientWidth - sliderBtn.clientWidth - 5;
    let newLeft = Math.max(5, Math.min(diff + 5, maxLeft));

    sliderBtn.style.left = newLeft + "px";
}

function endSlide() {
    if (!sliding) return;
    sliding = false;

    const maxLeft = container.clientWidth - sliderBtn.clientWidth - 5;
    const currentLeft = parseInt(sliderBtn.style.left);

    // ðŸ”™ Si NO llega al final â†’ vuelve al inicio con animaciÃ³n
    if (currentLeft < maxLeft - 5) {
        sliderBtn.style.transition = "left 0.3s";
        sliderBtn.style.left = "5px";
        setTimeout(() => sliderBtn.style.transition = "", 300);
        sliderBtn.classList.remove("active");
        return;
    }

    // ðŸ”“ Si llega al final â†’ abrir puerta
    sliderBtn.classList.remove("active");
    sliderBtn.classList.add("success");

    abrirPuertaSlide();
    resetSlider();
}

function resetSlider() {
    setTimeout(() => {
        sliderBtn.style.left = "5px";
        sliderBtn.classList.remove("success");
    }, 1200);
}

// ==================== API + VIBRACIÃ“N ====================
async function abrirPuertaSlide() {
    msg.innerText = "Abriendo puerta...";
    msg.style.color = "#0a6d1a";

    const resp = await fetch("http://localhost:3000/api/abrir", {
        method: "POST",
        credentials: "include"
    });

    const data = await resp.json();

    // VibraciÃ³n del celular
    if (navigator.vibrate) navigator.vibrate([80, 40, 80]);

    if (data.ok) {
        msg.innerText = "âœ” Puerta abierta";
        msg.style.color = "green";
    } else {
        msg.innerText = "âŒ Error al abrir puerta";
        msg.style.color = "red";
    }

    setTimeout(() => msg.innerText = "", 3000);
}

// ==================== LOGOUT ====================
function logout() {
    fetch("http://localhost:3000/logout", { credentials: "include" });
    location.href = "login.html";
}
</script>

</body>
</html>
